import{_ as p}from"./plugin-vue_export-helper-c27b6911.js";import{r as o,o as c,c as r,b as s,d as n,e as l,a as e}from"./app-d43c937a.js";const i={},D=s("h1",{id:"_003-nacos服务注册与配置中心",tabindex:"-1"},[s("a",{class:"header-anchor",href:"#_003-nacos服务注册与配置中心","aria-hidden":"true"},"#"),n(" 003-Nacos服务注册与配置中心")],-1),t=s("h2",{id:"_1-nacos-概述",tabindex:"-1"},[s("a",{class:"header-anchor",href:"#_1-nacos-概述","aria-hidden":"true"},"#"),n(" 1-Nacos 概述")],-1),d={href:"https://nacos.io",target:"_blank",rel:"noopener noreferrer"},y={href:"https://github.com/alibaba/nacos",target:"_blank",rel:"noopener noreferrer"},v=s("p",null,"以下的 Nacos 介绍来自 Nacos 官网：",-1),u=s("p",null,"Nacos /nɑ:kəʊs/ 是 Dynamic Naming and Configuration Service 的首字母简称，一个更易于构建云原生应用的动态服务发现、配置管理和服务管理平台。",-1),m=s("p",null,"Nacos 致力于帮助您发现、配置和管理微服务。Nacos 提供了一组简单易用的特性集，帮助您快速实现动态服务发现、服务配置、服务元数据及流量管理。",-1),b=s("p",null,"Nacos 帮助您更敏捷和容易地构建、交付和管理微服务平台。 Nacos 是构建以“服务”为中心的现代应用架构 (例如微服务范式、云原生范式) 的服务基础设施。",-1),C=s("h2",{id:"_2-nacos-的下载与安装",tabindex:"-1"},[s("a",{class:"header-anchor",href:"#_2-nacos-的下载与安装","aria-hidden":"true"},"#"),n(" 2-Nacos 的下载与安装")],-1),g={href:"https://github.com/alibaba/spring-cloud-alibaba/wiki/%E7%89%88%E6%9C%AC%E8%AF%B4%E6%98%8E",target:"_blank",rel:"noopener noreferrer"},h={href:"https://github.com/alibaba/nacos/releases%E3%80%82",target:"_blank",rel:"noopener noreferrer"},E=e(`<p>下载完成后在本地解压即可，解压后的 bin 目录里存放的是 Nacos 的启动脚本，在不同的系统下执行相应的启动脚本即可启动 Nacos，例如，在 Windows 系统下双击执行 startup.cmd 文件，就可以启动 Nacos，但此时会报错，这是因为 Nacos 默认的启动模式是集群，可以通过如下命令，以单例模式启动 Nacos。</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="shiki dark-plus" style="background-color:#1E1E1E;" tabindex="0"><code><span class="line"><span style="color:#DCDCAA;">startup.cmd</span><span style="color:#D4D4D4;"> </span><span style="color:#569CD6;">-m</span><span style="color:#D4D4D4;"> </span><span style="color:#CE9178;">standalone</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div>`,2),f={href:"http://localhost:8848/nacos",target:"_blank",rel:"noopener noreferrer"},N=e(`<figure><img src="https://cdn.jsdelivr.net/gh/mengyahui/image-repository@master/springcloud/image-20230609164217967.24zkxin9f940.png" alt="image-20230609164217967" tabindex="0" loading="lazy"><figcaption>image-20230609164217967</figcaption></figure><h2 id="_3-nacos-注册中心" tabindex="-1"><a class="header-anchor" href="#_3-nacos-注册中心" aria-hidden="true">#</a> 3-Nacos 注册中心</h2><h3 id="_3-1-服务注册中心介绍" tabindex="-1"><a class="header-anchor" href="#_3-1-服务注册中心介绍" aria-hidden="true">#</a> 3.1 服务注册中心介绍</h3><p>在微服务架构中，一个系统通常被拆分为多个模块 / 服务，在服务是单实例情况下，可以采用点对点的 HTTP 直接调用，即 IP + Port + 接口的形式。但模块 / 服务通常都是多实例集群部署，用以减轻服务器的压力。</p><p>在多实例集群部署服务时，我们不得不考虑如下几个问题：</p><ol><li>调用方如何知晓调用哪个实例？</li><li>当实例运行失败后，如何转移到别的实例上去处理请求？</li></ol><p>服务注册中心便是为了解决上述问题，将所有的服务统一的、动态的管理起来。<strong>所有的服务都与注册中心发生连接，由注册中心统一配置管理，不再由实例自身直接调用</strong>。</p><p>服务管理的过程大致如下：</p><ol><li>服务提供者启动时，将服务提供者的信息主动提交到服务注册中心进行服务注册。</li><li>服务调用者启动时，将服务提供者信息从注册中心下载到调用者本地，调用者从本地的服务提供者列表中，基于某种负载均衡策略选择一台服务实例发起远程调用，这是一个点到点调用的方式。</li><li>服务注册中心能够感知服务提供者某个实例下线，同时将该实例服务提供者信息从注册中心清除，并通知服务调用者集群中的每一个实例，告知服务调用者不再调用本实例，以免调用失败。</li></ol><h3 id="_3-2-搭建-nacos-注册中心" tabindex="-1"><a class="header-anchor" href="#_3-2-搭建-nacos-注册中心" aria-hidden="true">#</a> 3.2 搭建 Nacos 注册中心</h3><h4 id="_3-2-1-导入坐标" tabindex="-1"><a class="header-anchor" href="#_3-2-1-导入坐标" aria-hidden="true">#</a> 3.2.1 导入坐标</h4><p>所有的服务都需要注册到 Nacos 注册中心，这里将 Nacos 服务发现与注册的坐标导入 mall-services 模块中：</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="shiki dark-plus" style="background-color:#1E1E1E;" tabindex="0"><code><span class="line"><span style="color:#808080;">&lt;</span><span style="color:#569CD6;">dependency</span><span style="color:#808080;">&gt;</span></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#808080;">&lt;</span><span style="color:#569CD6;">groupId</span><span style="color:#808080;">&gt;</span><span style="color:#D4D4D4;">com.alibaba.cloud</span><span style="color:#808080;">&lt;/</span><span style="color:#569CD6;">groupId</span><span style="color:#808080;">&gt;</span></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#808080;">&lt;</span><span style="color:#569CD6;">artifactId</span><span style="color:#808080;">&gt;</span><span style="color:#D4D4D4;">spring-cloud-starter-alibaba-nacos-discovery</span><span style="color:#808080;">&lt;/</span><span style="color:#569CD6;">artifactId</span><span style="color:#808080;">&gt;</span></span>
<span class="line"><span style="color:#808080;">&lt;/</span><span style="color:#569CD6;">dependency</span><span style="color:#808080;">&gt;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_3-2-2-nacos-服务发现配置" tabindex="-1"><a class="header-anchor" href="#_3-2-2-nacos-服务发现配置" aria-hidden="true">#</a> 3.2.2 Nacos 服务发现配置</h4><p>这里以 mall-user-server 服务为例，在 application.yml 中配置的 Nacos 服务发现的具体信息为：</p><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="shiki dark-plus" style="background-color:#1E1E1E;" tabindex="0"><code><span class="line"><span style="color:#569CD6;">spring</span><span style="color:#D4D4D4;">:</span></span>
<span class="line"><span style="color:#D4D4D4;">  </span><span style="color:#569CD6;">application</span><span style="color:#D4D4D4;">:</span></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#569CD6;">name</span><span style="color:#D4D4D4;">: </span><span style="color:#CE9178;">mall-user-server</span></span>
<span class="line"><span style="color:#D4D4D4;">  </span><span style="color:#569CD6;">cloud</span><span style="color:#D4D4D4;">:</span></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#569CD6;">nacos</span><span style="color:#D4D4D4;">:</span></span>
<span class="line"><span style="color:#D4D4D4;">      </span><span style="color:#569CD6;">server-addr</span><span style="color:#D4D4D4;">: </span><span style="color:#CE9178;">127.0.0.1:8848</span><span style="color:#D4D4D4;"> </span><span style="color:#6A9955;"># Nacos 服务地址</span></span>
<span class="line"><span style="color:#D4D4D4;">      </span><span style="color:#569CD6;">discovery</span><span style="color:#D4D4D4;">:</span></span>
<span class="line"><span style="color:#D4D4D4;">      </span><span style="color:#6A9955;"># 服务注册的名称，默认是:spring.application.name</span></span>
<span class="line"><span style="color:#D4D4D4;">        </span><span style="color:#569CD6;">service</span><span style="color:#D4D4D4;">: </span><span style="color:#CE9178;">\${spring.application.name}</span><span style="color:#D4D4D4;"> </span></span>
<span class="line"><span style="color:#D4D4D4;">        </span><span style="color:#6A9955;"># 服务注册的地址，默认是:spring.cloud.nacos.server-addr</span></span>
<span class="line"><span style="color:#D4D4D4;">        </span><span style="color:#569CD6;">server-addr</span><span style="color:#D4D4D4;">: </span><span style="color:#CE9178;">\${spring.cloud.nacos.server-addr}</span><span style="color:#D4D4D4;"> </span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>此时，只需要在各个服务的启动类或配置类上加上 <code>@EnableDiscoveryClient</code> 注解用于开启服务注册与发现的支持，服务就可以注册到 Nacos，但经过实际测试不加 <code>@EnableDiscoveryClient</code> 注解，服务也能注册到 Nacos。</p><blockquote><p>在配置 <code>spring.application.name</code> 和 <code>spring.cloud.nacos.server-addr</code> 的前提下，可以不配置 <code>spring.cloud.nacos.service</code> 和 <code>spring.cloud.nacos.discovery</code>。</p></blockquote><h3 id="_3-3-nacos-领域模型" tabindex="-1"><a class="header-anchor" href="#_3-3-nacos-领域模型" aria-hidden="true">#</a> 3.3 Nacos 领域模型</h3><p><strong>Nacos 领域模型描述了服务与实例之间的边界和层级关系。<strong>Nacos 的服务领域模型是以</strong>服务</strong>为维度构建起来的，这个服务并不是指集群中的单个服务器，而是指微服务的服务名。<strong>服务</strong>是 Nacos 中位于最上层的概念，在服务之下，还有<strong>集群</strong>和<strong>实例</strong>的概念。</p><figure><img src="https://cdn.jsdelivr.net/gh/mengyahui/image-repository@master/springcloud/image-20230609205457741.3ofjmn24h0i0.png" alt="image-20230609205457741" tabindex="0" loading="lazy"><figcaption>image-20230609205457741</figcaption></figure><h4 id="_3-2-1-服务" tabindex="-1"><a class="header-anchor" href="#_3-2-1-服务" aria-hidden="true">#</a> 3.2.1 服务</h4><p>在服务这个层级上可以配置元数据和服务保护阈值等信息。服务阈值是一个 0~1 之间的 数字，当服务的健康实例数与总实例的比例小于这个阈值的时候，说明能提供服务的机器已经 没多少了。这时候 Nacos 会开启服务保护模式，不再主动剔除服务实例，同时还会将不健康 的实例也返回给消费者。</p><h4 id="_3-2-2-集群" tabindex="-1"><a class="header-anchor" href="#_3-2-2-集群" aria-hidden="true">#</a> 3.2.2 集群</h4><p>一个服务由很多服务实例组成，在每个服务实例启动的时候，可以设置它所属的集群，在集群这个层级上，也可以配置元数据。除此之外，还可以为持久化节点设置健康检查模式。</p><p>所谓持久化节点，是一种会保存到 Nacos 服务端的节点，即便该节点的客户端进程没有在运行，节点也不会被服务端删除，只不过 Nacos 会将这个持久化节点的状态标记为不健康， Nacos 可以采用一种“主动探活”的方式来对持久化节点做健康检查。</p><p>除了持久化节点以外，大部分服务节点在 Nacos 中以 “临时节点” 的方式存在，它是默认的服务注册方式，从名字中就可以看出，这种节点不会被持久化保存在 Nacos 服务器，临时节点通过主动发送 heartbeat 请求向服务器报送自己的状态。</p><h4 id="_3-2-3-实例" tabindex="-1"><a class="header-anchor" href="#_3-2-3-实例" aria-hidden="true">#</a> 3.2.3 实例</h4><p>这里所说的实例就是指服务节点，可以在 Nacos 控制台查看每个实例的 IP 地址和端口、 编辑实例的元数据信息、修改它的上线 / 下线状态或者配置路由权重等等。</p><p>在这三个层级上都有 “元数据” 这一数据结构，可以把它理解为一组包含了服务描述信息（如服务版本等）和自定义标签的数据集合。Client 端通过服务发现技术可以获取到 每个服务实例的元数据，可以将自定义的属性加入到元数据并在 Client 端实现某些定制化的业务场景。</p><h3 id="_3-4-nacos-数据模型" tabindex="-1"><a class="header-anchor" href="#_3-4-nacos-数据模型" aria-hidden="true">#</a> 3.4 Nacos 数据模型</h3><p>Nacos 的数据模型有三个层次结构，分别是 Namespace、Group 和 Service/DataId。</p><ul><li><p>Namespace：即命名空间，它是最顶层的数据结构，可以用它来区分开发环境、生产环境等不同环境。默认情况下，所有服务都部署到一个叫做 “public” 的公共命名空间；</p></li><li><p>Group：在命名空间之下有一个分组结构，默认情况下所有微服务都属于 “DEFAULT_GROUP” 这个分组，不同分组间的微服务是相互隔离的；</p></li><li><p>Service/DataID：在 Group 分组之下，就是具体的微服务了，比如订单服务、商品服务等等。</p></li></ul><figure><img src="https://cdn.jsdelivr.net/gh/mengyahui/image-repository@master/springcloud/image-20230609210818177.74msn75ly0w0.png" alt="image-20230609210818177" tabindex="0" loading="lazy"><figcaption>image-20230609210818177</figcaption></figure><p>通过 Namespace + Group + Service/DataID，就可以精准定位到一个具体的微服务</p><h4 id="_3-4-1-namespace" tabindex="-1"><a class="header-anchor" href="#_3-4-1-namespace" aria-hidden="true">#</a> 3.4.1 Namespace</h4><p>不同的命名空间逻辑上是隔离的，不特殊设置的情况下，服务不会跨命名空间请求，命名空间主要的作用是区分服务使用的范围，比如开发、测试、生产可以分别设置三个命名空间来互相隔离。在不设置的情况下，只有一个保留空间 public。</p><p>设置命名空间也很简单，首先在 nacos 控制台新建命名空间，如下图所示：</p><figure><img src="https://cdn.jsdelivr.net/gh/mengyahui/image-repository@master/springcloud/image-20230609211316753.1n47u116f600.png" alt="image-20230609211316753" tabindex="0" loading="lazy"><figcaption>image-20230609211316753</figcaption></figure><p>在创建命名空间时，我们不必填写命名空间 ID，系统会自动生成，可以在控制台查看命名空间的 ID。接下来就可以在 Nacos 的注册配置中将服务注册到此命名空间下，例如这里将 mall-user 服务注册到此命名空间下，代码如下：</p><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="shiki dark-plus" style="background-color:#1E1E1E;" tabindex="0"><code><span class="line"><span style="color:#569CD6;">spring</span><span style="color:#D4D4D4;">:</span></span>
<span class="line"><span style="color:#D4D4D4;">  </span><span style="color:#569CD6;">application</span><span style="color:#D4D4D4;">:</span></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#569CD6;">name</span><span style="color:#D4D4D4;">: </span><span style="color:#CE9178;">mall-user</span></span>
<span class="line"><span style="color:#D4D4D4;">  </span><span style="color:#569CD6;">cloud</span><span style="color:#D4D4D4;">:</span></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#569CD6;">nacos</span><span style="color:#D4D4D4;">:</span></span>
<span class="line"><span style="color:#D4D4D4;">      </span><span style="color:#569CD6;">server-addr</span><span style="color:#D4D4D4;">: </span><span style="color:#CE9178;">127.0.0.1:8848</span></span>
<span class="line"><span style="color:#D4D4D4;">      </span><span style="color:#569CD6;">discovery</span><span style="color:#D4D4D4;">:</span></span>
<span class="line"><span style="color:#D4D4D4;">        </span><span style="color:#569CD6;">service</span><span style="color:#D4D4D4;">: </span><span style="color:#CE9178;">\${spring.application.name}</span></span>
<span class="line"><span style="color:#D4D4D4;">        </span><span style="color:#569CD6;">server-addr</span><span style="color:#D4D4D4;">: </span><span style="color:#CE9178;">\${spring.cloud.nacos.server-addr}</span></span>
<span class="line"><span style="color:#D4D4D4;">        </span><span style="color:#569CD6;">namespace</span><span style="color:#D4D4D4;">: </span><span style="color:#CE9178;">4331959a-47d7-48d1-8995-1e606968dfe1</span><span style="color:#D4D4D4;"> </span><span style="color:#6A9955;"># Nacos 控制台生成的命名空间ID</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_3-4-2-group" tabindex="-1"><a class="header-anchor" href="#_3-4-2-group" aria-hidden="true">#</a> 3.4.2 Group</h4><p>Group 可以在 Namespace 基础上进行更加细致的隔离，Group 具体的使用场景主要有如下几个方面：</p><ol><li>配置分组</li></ol><p>Group 的最常用的场景就是配置分组，一个命名空间下的一些服务都用到了一些相同的配置，就可以将这些服务分配到同一个组中，再将这些服务都用到的配置信息，抽取为改分组下的一个配置文件，这样只有在该分组的服务才能使用这个配置文件。</p><ol start="2"><li>服务分类</li></ol><p>在企业级应用系统中，通常会有多个服务同时运行，可能包含了不同功能、不同频率和不同负载的服务。使用 Nacos 的 Group 功能可以将这些服务按照自定义的规则进行分类，以便更好地区分和管理。</p><ol start="3"><li>灰度发布</li></ol><p>灰度发布是基于服务的，在 Nacos 中服务的 Group 就是实现灰度发布的关键，在灰度发布中，通常将新版本的服务和旧版本的服务同时运行一段时间，然后再逐步将新版本的服务全部投入使用。可以将新版本的服务和旧版本的服务归类到不同的组中，通过不断调节不同组的服务权重来实现灰度发布。</p><h2 id="_4-nacos-集群" tabindex="-1"><a class="header-anchor" href="#_4-nacos-集群" aria-hidden="true">#</a> 4 Nacos 集群</h2><p>Nacos 支持两种部署模式：单机模式和集群模式。在开发中，我们习惯用单机模式快速构建一个 Nacos 开发/测试环境，而在生产中，出于高可用的考虑，一定需要使用 Nacos 集群部署模式。Nacos 为高可用做了非常多的特性支持，而这些高可用特性大多数都依赖于集群部署模式。</p><h3 id="_4-1-nacos-集群架构" tabindex="-1"><a class="header-anchor" href="#_4-1-nacos-集群架构" aria-hidden="true">#</a> 4.1 Nacos 集群架构</h3><p>下图是 Nacos 官方文档给出的 Nacos 集群部署架构图，其中的 SLB 表示负载均衡，外部服务向 Nacos 发起注册时，首先会经过 SLB，通常使用 Nginx，为了保证高可用 Nginx 也可以做集群，通过 Nginx 来分发到具体的 Nacos 服务器上面。</p><figure><img src="https://cdn.jsdelivr.net/gh/mengyahui/image-repository@master/springcloud/deployDnsVipMode.3bnwy73qeqm0.jpg" alt="deployDnsVipMode" tabindex="0" loading="lazy"><figcaption>deployDnsVipMode</figcaption></figure><h3 id="_4-2-数据持久化配置" tabindex="-1"><a class="header-anchor" href="#_4-2-数据持久化配置" aria-hidden="true">#</a> 4.2 数据持久化配置</h3><p>Nacos 默认数据存储在内嵌数据库 Derby 中，不属于生产可用的数据库。官方推荐的最佳实践是使用带有主从的高可用数据库集群，这里以单点的外部数据库 MySQL 为例。可以使用 Docker 在虚拟机上安装 MySQL，命令如下：</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="shiki dark-plus" style="background-color:#1E1E1E;" tabindex="0"><code><span class="line"><span style="color:#DCDCAA;">docker</span><span style="color:#D4D4D4;"> </span><span style="color:#CE9178;">run</span><span style="color:#D4D4D4;"> </span><span style="color:#D7BA7D;">\\</span></span>
<span class="line"><span style="color:#D4D4D4;">		</span><span style="color:#569CD6;">-p</span><span style="color:#D4D4D4;"> </span><span style="color:#B5CEA8;">3306</span><span style="color:#CE9178;">:3306</span><span style="color:#D4D4D4;"> </span><span style="color:#D7BA7D;">\\</span></span>
<span class="line"><span style="color:#D4D4D4;">		</span><span style="color:#569CD6;">--name</span><span style="color:#D4D4D4;"> </span><span style="color:#CE9178;">mysql</span><span style="color:#D4D4D4;"> </span><span style="color:#D7BA7D;">\\</span></span>
<span class="line"><span style="color:#D4D4D4;">		</span><span style="color:#569CD6;">-v</span><span style="color:#D4D4D4;"> </span><span style="color:#CE9178;">/docker/mysql/logs:/logs</span><span style="color:#D4D4D4;"> </span><span style="color:#D7BA7D;">\\</span></span>
<span class="line"><span style="color:#D4D4D4;">		</span><span style="color:#569CD6;">-v</span><span style="color:#D4D4D4;"> </span><span style="color:#CE9178;">/docker/mysql/data:/var/lib/mysql</span><span style="color:#D4D4D4;"> </span><span style="color:#D7BA7D;">\\</span></span>
<span class="line"><span style="color:#D4D4D4;">		</span><span style="color:#569CD6;">-v</span><span style="color:#D4D4D4;"> </span><span style="color:#CE9178;">/docker/mysql/conf:/etc/mysql/conf.d</span><span style="color:#D4D4D4;"> </span><span style="color:#D7BA7D;">\\</span></span>
<span class="line"><span style="color:#D4D4D4;">		</span><span style="color:#569CD6;">-e</span><span style="color:#D4D4D4;"> </span><span style="color:#CE9178;">MYSQL_ROOT_PASSWORD=root</span><span style="color:#D4D4D4;"> </span><span style="color:#D7BA7D;">\\</span></span>
<span class="line"><span style="color:#D4D4D4;">		</span><span style="color:#569CD6;">-d</span><span style="color:#D4D4D4;"> </span><span style="color:#CE9178;">mysql:8.0.17</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>首先，在 nacos 安装目录的 conf 目录下找到 nacos-mysql.sql 文件，需要在名为 nacos_config 的数据库中执行这个文件。</p><p>接着，在 nacos 安装目录的 conf 目录下找到 application.properties 文件，修改其中的数据库配置，除了下面的数据库平台配置和数据库数量配置外，还要保证连接的数据库地址的正确性。</p><div class="language-properties line-numbers-mode" data-ext="properties"><pre class="shiki dark-plus" style="background-color:#1E1E1E;" tabindex="0"><code><span class="line"><span style="color:#569CD6;">spring.datasource.platform</span><span style="color:#D4D4D4;">=mysql </span><span style="color:#6A9955;"># 使用mysql数据库</span></span>
<span class="line"><span style="color:#569CD6;">db.num</span><span style="color:#D4D4D4;">=1 </span><span style="color:#6A9955;"># 数据库的数量</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_4-3-搭建-nacos-集群" tabindex="-1"><a class="header-anchor" href="#_4-3-搭建-nacos-集群" aria-hidden="true">#</a> 4.3 搭建 Nacos 集群</h3><h4 id="_4-3-1-nacos-集群配置" tabindex="-1"><a class="header-anchor" href="#_4-3-1-nacos-集群配置" aria-hidden="true">#</a> 4.3.1 Nacos 集群配置</h4><p>在做好 Nacos 持久化之后，需要在 Nacos 安装目录的 conf 目录下，将 cluster.conf.example 文件重命名为 cluster.conf，然后打开这个文件，添加需要集群 Nacos 的 IP 信息。</p><p>这里采用在本地机器上启动三个 Nacos 实例为例，来说明 Nacos 的集群部署。需要在 cluster.conf 集群配置文件中添加本地及其不同端口的三个 Nacos IP 信息，这里需要保证保证端口不连续，否则会出现集群异常。下面是我本地配置的三台 Nacos IP 信息：</p><table><thead><tr><th>Nacos 服务</th><th>IP</th></tr></thead><tbody><tr><td>nacos server 8848</td><td>192.168.0.107:8848</td></tr><tr><td>nacos server 8858</td><td>192.168.0.107:8858</td></tr><tr><td>nacos server 8868</td><td>192.168.0.107:8868</td></tr></tbody></table><p>然后，将 Nacos 安装目录复制三份，分别命名为 nacos-8848、nacos-8858、nacos-8868。</p><p>最后，需要分别修改这三个 Nacos 的 application.properties 中配置的 Nacos 端口，需要和 Nacos 的 IP 信息 一一对应。</p><h4 id="_4-3-2-nginx-配置" tabindex="-1"><a class="header-anchor" href="#_4-3-2-nginx-配置" aria-hidden="true">#</a> 4.3.2 Nginx 配置</h4><p>这里以 Windows 版的 Nginx 为例，修改其 conf 目录下的 nginx.conf 文件：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="shiki dark-plus" style="background-color:#1E1E1E;" tabindex="0"><code><span class="line"><span style="color:#D4D4D4;">upstream nacos-cluster {</span></span>
<span class="line"><span style="color:#D4D4D4;">    server </span><span style="color:#B5CEA8;">192.168</span><span style="color:#D4D4D4;">.</span><span style="color:#F44747;">0</span><span style="color:#D4D4D4;">.</span><span style="color:#F44747;">107</span><span style="color:#C586C0;">:</span><span style="color:#B5CEA8;">8848</span><span style="color:#D4D4D4;">;</span></span>
<span class="line"><span style="color:#D4D4D4;">    server </span><span style="color:#B5CEA8;">192.168</span><span style="color:#D4D4D4;">.</span><span style="color:#F44747;">0</span><span style="color:#D4D4D4;">.</span><span style="color:#F44747;">107</span><span style="color:#C586C0;">:</span><span style="color:#B5CEA8;">8858</span><span style="color:#D4D4D4;">;</span></span>
<span class="line"><span style="color:#D4D4D4;">    server </span><span style="color:#B5CEA8;">192.168</span><span style="color:#D4D4D4;">.</span><span style="color:#F44747;">0</span><span style="color:#D4D4D4;">.</span><span style="color:#F44747;">107</span><span style="color:#C586C0;">:</span><span style="color:#B5CEA8;">8868</span><span style="color:#D4D4D4;">;</span></span>
<span class="line"><span style="color:#D4D4D4;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">server {</span></span>
<span class="line"><span style="color:#D4D4D4;">    listen       </span><span style="color:#B5CEA8;">80</span><span style="color:#D4D4D4;">;</span></span>
<span class="line"><span style="color:#D4D4D4;">    server_name  localhost;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">    location /nacos {</span></span>
<span class="line"><span style="color:#D4D4D4;">        proxy_pass http</span><span style="color:#C586C0;">:</span><span style="color:#6A9955;">//nacos-cluster;</span></span>
<span class="line"><span style="color:#D4D4D4;">    }</span></span>
<span class="line"><span style="color:#D4D4D4;">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这里的 192.168.0.107 为本机电脑的 IPv4 地址。如果使用 127.0.0.1，Nacos 集群启动后，不仅会注册 127.0.0.1 相应的集群，也会注册 192.168.0.107 相应的集群。</p>`,71),_={href:"http://localhost:80/nacos",target:"_blank",rel:"noopener noreferrer"},x=e(`<figure><img src="https://cdn.jsdelivr.net/gh/mengyahui/image-repository@master/springcloud/image-20230707094529973.4xdi7gxvv180.png" alt="image-20230707094529973" tabindex="0" loading="lazy"><figcaption>image-20230707094529973</figcaption></figure><p>可以通过如下配置将服务注册到搭建的 Nacos 集群上：</p><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="shiki dark-plus" style="background-color:#1E1E1E;" tabindex="0"><code><span class="line"><span style="color:#569CD6;">server</span><span style="color:#D4D4D4;">:</span></span>
<span class="line"><span style="color:#D4D4D4;">  </span><span style="color:#569CD6;">port</span><span style="color:#D4D4D4;">: </span><span style="color:#B5CEA8;">7000</span></span>
<span class="line"></span>
<span class="line"><span style="color:#569CD6;">spring</span><span style="color:#D4D4D4;">:</span></span>
<span class="line"><span style="color:#D4D4D4;">  </span><span style="color:#569CD6;">application</span><span style="color:#D4D4D4;">:</span></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#569CD6;">name</span><span style="color:#D4D4D4;">: </span><span style="color:#CE9178;">mall-user</span></span>
<span class="line"><span style="color:#D4D4D4;">  </span><span style="color:#569CD6;">cloud</span><span style="color:#D4D4D4;">:</span></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#569CD6;">nacos</span><span style="color:#D4D4D4;">:</span></span>
<span class="line"><span style="color:#D4D4D4;">      </span><span style="color:#569CD6;">server-addr</span><span style="color:#D4D4D4;">: </span><span style="color:#CE9178;">192.168.0.107:80</span></span>
<span class="line"><span style="color:#D4D4D4;">      </span><span style="color:#569CD6;">discovery</span><span style="color:#D4D4D4;">:</span></span>
<span class="line"><span style="color:#D4D4D4;">        </span><span style="color:#569CD6;">service</span><span style="color:#D4D4D4;">: </span><span style="color:#CE9178;">\${spring.application.name}</span></span>
<span class="line"><span style="color:#D4D4D4;">        </span><span style="color:#569CD6;">server-addr</span><span style="color:#D4D4D4;">: </span><span style="color:#CE9178;">\${spring.cloud.nacos.server-addr}</span></span>
<span class="line"><span style="color:#D4D4D4;">        </span><span style="color:#569CD6;">cluster-name</span><span style="color:#D4D4D4;">: </span><span style="color:#CE9178;">Shanghai</span><span style="color:#D4D4D4;"> </span><span style="color:#6A9955;"># 集群名字，可以用地区命名,默认的集群名字为 DEFAULT</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_4-4-权重策略" tabindex="-1"><a class="header-anchor" href="#_4-4-权重策略" aria-hidden="true">#</a> 4.4 权重策略</h3><p>在项目的实际部署过程中，不同机器之间存在性能差异，我们希望性能好的机器承担更多的用户请求，但默认情况下 NacosRule 是同集群内随机挑选，不会考虑机器性能问题。</p><p>SpringCloud Alibaba Nacos 默认提供了名为 <code>NacosLoadBalancer</code> 的负载均衡规则，其负载均衡规则首先会选择同一个集群下的服务，然后再根据服务的权重进行选择。</p><p>默认情况下，Nacos 的权重选择是关闭的，仅仅使用轮询策略，可使用如下配置来开启 Nacos 的权重策略：</p><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="shiki dark-plus" style="background-color:#1E1E1E;" tabindex="0"><code><span class="line"><span style="color:#569CD6;">spring</span><span style="color:#D4D4D4;">:</span></span>
<span class="line"><span style="color:#D4D4D4;">  </span><span style="color:#569CD6;">cloud</span><span style="color:#D4D4D4;">:</span></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#569CD6;">loadbalancer</span><span style="color:#D4D4D4;">:</span></span>
<span class="line"><span style="color:#D4D4D4;">      </span><span style="color:#569CD6;">nacos</span><span style="color:#D4D4D4;">:</span></span>
<span class="line"><span style="color:#D4D4D4;">      	</span><span style="color:#569CD6;">enabled</span><span style="color:#D4D4D4;">: </span><span style="color:#569CD6;">true</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Nacos 的权重配置可以在 Nacos 控制台进行配置，其值介于 0~1 之间，权重越大则访问频率越高，权重为 0 的 Nacos 实例永远不会被访问。</p><blockquote><p>如果未给服务器设置权重，建议不要使用基于权重的策略，因为如果微服务的权重都相同，相当于随机</p></blockquote><p>我们可以在本地再启动一份 mall-user-server，配置如下：</p><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="shiki dark-plus" style="background-color:#1E1E1E;" tabindex="0"><code><span class="line"><span style="color:#569CD6;">server</span><span style="color:#D4D4D4;">:</span></span>
<span class="line"><span style="color:#D4D4D4;">  </span><span style="color:#569CD6;">port</span><span style="color:#D4D4D4;">: </span><span style="color:#B5CEA8;">7001</span></span>
<span class="line"></span>
<span class="line"><span style="color:#569CD6;">spring</span><span style="color:#D4D4D4;">:</span></span>
<span class="line"><span style="color:#D4D4D4;">  </span><span style="color:#569CD6;">application</span><span style="color:#D4D4D4;">:</span></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#569CD6;">name</span><span style="color:#D4D4D4;">: </span><span style="color:#CE9178;">mall-user-server</span></span>
<span class="line"><span style="color:#D4D4D4;">  </span><span style="color:#569CD6;">cloud</span><span style="color:#D4D4D4;">:</span></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#569CD6;">nacos</span><span style="color:#D4D4D4;">:</span></span>
<span class="line"><span style="color:#D4D4D4;">      </span><span style="color:#569CD6;">server-addr</span><span style="color:#D4D4D4;">: </span><span style="color:#CE9178;">192.168.0.107:80</span></span>
<span class="line"><span style="color:#D4D4D4;">      </span><span style="color:#569CD6;">discovery</span><span style="color:#D4D4D4;">:</span></span>
<span class="line"><span style="color:#D4D4D4;">        </span><span style="color:#569CD6;">service</span><span style="color:#D4D4D4;">: </span><span style="color:#CE9178;">\${spring.application.name}</span></span>
<span class="line"><span style="color:#D4D4D4;">        </span><span style="color:#569CD6;">server-addr</span><span style="color:#D4D4D4;">: </span><span style="color:#CE9178;">\${spring.cloud.nacos.server-addr}</span></span>
<span class="line"><span style="color:#D4D4D4;">        </span><span style="color:#569CD6;">cluster-name</span><span style="color:#D4D4D4;">: </span><span style="color:#CE9178;">Shanghai</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>现在就可以在 Nacos 的 Shanghai 集群里看到两个 mall-user-server 实例了</p><figure><img src="https://cdn.jsdelivr.net/gh/mengyahui/image-repository@master/springcloud/image-20230707100922402.1ny8yvotse8w.png" alt="image-20230707100922402" tabindex="0" loading="lazy"><figcaption>image-20230707100922402</figcaption></figure><h3 id="_4-5-临时-持久化实例" tabindex="-1"><a class="header-anchor" href="#_4-5-临时-持久化实例" aria-hidden="true">#</a> 4.5 临时/持久化实例</h3><p>注册到 Nacos 的服务实例默认都是临时实例，临时实例每隔一段时间想 Nacos 发送一个心跳请求来告诉 Nacos 自己还活着，和 Eureka 一样，如果心跳停止，则 Nacos 会将其从服务列表中剔除。</p><p>对于持久化实例 Nacos 会主动发送请求询问其是否活着，若是死了，则会等待其恢复健康，而并不是剔除。可以通过如下配置将服务注册为持久化实例：</p><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="shiki dark-plus" style="background-color:#1E1E1E;" tabindex="0"><code><span class="line"><span style="color:#569CD6;">spring</span><span style="color:#D4D4D4;">:</span></span>
<span class="line"><span style="color:#D4D4D4;">  </span><span style="color:#569CD6;">application</span><span style="color:#D4D4D4;">:</span></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#569CD6;">name</span><span style="color:#D4D4D4;">: </span><span style="color:#CE9178;">mall-user</span></span>
<span class="line"><span style="color:#D4D4D4;">  </span><span style="color:#569CD6;">cloud</span><span style="color:#D4D4D4;">:</span></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#569CD6;">nacos</span><span style="color:#D4D4D4;">:</span></span>
<span class="line"><span style="color:#D4D4D4;">      </span><span style="color:#569CD6;">server-addr</span><span style="color:#D4D4D4;">: </span><span style="color:#CE9178;">192.168.0.107:80</span></span>
<span class="line"><span style="color:#D4D4D4;">      </span><span style="color:#569CD6;">discovery</span><span style="color:#D4D4D4;">:</span></span>
<span class="line"><span style="color:#D4D4D4;">        </span><span style="color:#569CD6;">service</span><span style="color:#D4D4D4;">: </span><span style="color:#CE9178;">\${spring.application.name}</span></span>
<span class="line"><span style="color:#D4D4D4;">        </span><span style="color:#569CD6;">server-addr</span><span style="color:#D4D4D4;">: </span><span style="color:#CE9178;">\${spring.cloud.nacos.server-addr}</span></span>
<span class="line"><span style="color:#D4D4D4;">        </span><span style="color:#569CD6;">cluster-name</span><span style="color:#D4D4D4;">: </span><span style="color:#CE9178;">Shanghai</span></span>
<span class="line"><span style="color:#D4D4D4;">        </span><span style="color:#569CD6;">namespace</span><span style="color:#D4D4D4;">: </span><span style="color:#CE9178;">f354ee02-7bd3-4743-bcd1-b5683b5050a7</span></span>
<span class="line"><span style="color:#D4D4D4;">        </span><span style="color:#569CD6;">ephemeral</span><span style="color:#D4D4D4;">: </span><span style="color:#569CD6;">false</span><span style="color:#D4D4D4;"> </span><span style="color:#6A9955;"># 注册持久化实例</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这里新建了一个命名空间，这是因为 <strong>public 命名空间下的服务是无法被注册为持久化实例的</strong>。</p><h3 id="_4-6-保护阈值" tabindex="-1"><a class="header-anchor" href="#_4-6-保护阈值" aria-hidden="true">#</a> 4.6 保护阈值</h3><p>Nacos 设计了临时实例和持久化实两种服务注册模式，这与 Nacos 的保护阈值息息相关。本质上，保护阈值是⼀个⽐例值（当前服务健康实例数/当前服务总实例数）。</p><p>服务消费者从 Nacos 拉去服务时，获取的实例有健康可不健康之分，Nacos 在返回实例时，只会返回健康实例。</p><p>但在⾼并发、⼤流量场景会存在⼀定的问题。比如，服务 A 有 100 个实例，其中 98 个实例都处于不健康状态，如果 Nacos 只返回其中的两个健康实例的话。流量洪峰的到来可能会直接打垮这两个服务，进一步产生雪崩效应。</p><p>若（当前服务健康实例数/当前服务总实例数）&lt; 保护阈值时，Nacos 会把该服务所有的实例信息（健康的+不健康的）全部提供给消费者，消费者可能访问到不健康的实例，请求失败，但这样也⽐造成雪崩要好。牺牲了⼀些请求，保证了整个系统的可⽤。</p><p>所以，对于永久实例来说，即使它们挂掉了，状态为不健康的，但当触发保护阈值时，还是可以起到分流的作用，这就是 Nacos 设计两种服务注册模式的意义。</p><h2 id="_5-nacos-配置中心" tabindex="-1"><a class="header-anchor" href="#_5-nacos-配置中心" aria-hidden="true">#</a> 5-Nacos 配置中心</h2><h3 id="_5-1-服务配置中心介绍" tabindex="-1"><a class="header-anchor" href="#_5-1-服务配置中心介绍" aria-hidden="true">#</a> 5.1 服务配置中心介绍</h3><p>顾名思义，配置中心就是一个统一存放配置的地方。为什么我们会需要配置中心？</p><p>在没有配置中心之前，项目的配置存在如下问题：</p><ol><li>采用本地静态配置，无法保证实时性：修改配置不灵活且需要经过较长的测试发布周期，无法尽快通知到客户端，还有些配置对实时性要求很高，比方说主备切换配置或者碰上故障需要修改配置，这时通过传统的静态配置或者重新发布的方式去配置，那么响应速度是非常慢的，业务风险非常大；</li><li>易引发生产事故：比如在发布的时候，容易将测试环境的配置带到生产上，引发生产事故；</li><li>配置散乱且格式不标准：有的用 properties 格式，有的用 xml 格式，还有的存储在数据库中；</li><li>配置缺乏安全审计、版本控制、配置权限控制功能：谁？在什么时间？修改了什么配置？无从追溯，出了问题也无法及时回滚到上一个版本；无法对配置的变更发布进行认证授权，所有人都能修改和发布配置。</li></ol><p>而配置中心区别于传统的配置信息分散到系统各个角落的方式，对系统中的配置文件进行集中统一管理，而不需要逐一对单个的服务器进行管理。那这样做有什么好处呢？</p><ol><li>通过配置中心，可以使得配置标准化、格式统一化；</li><li>当配置信息发生变动时，修改实时生效，无需要重新重启服务器，就能够自动感知相应的变化，并将新的变化统一发送到相应程序上，快速响应变化。</li><li>将配置和发布包解藕进一步提升发布的成功率，并为运维的细力度管控、应急处理等提供强有力的支持。</li></ol><h3 id="_5-2-搭建-nacos-配置中心" tabindex="-1"><a class="header-anchor" href="#_5-2-搭建-nacos-配置中心" aria-hidden="true">#</a> 5.2 搭建 Nacos 配置中心</h3><h4 id="_5-2-1-导入坐标" tabindex="-1"><a class="header-anchor" href="#_5-2-1-导入坐标" aria-hidden="true">#</a> 5.2.1 导入坐标</h4><p>每个服务都需要使用 Nacos 配置中心，将其坐标导入 mall-services 模块下：</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="shiki dark-plus" style="background-color:#1E1E1E;" tabindex="0"><code><span class="line"><span style="color:#808080;">&lt;</span><span style="color:#569CD6;">dependencies</span><span style="color:#808080;">&gt;</span></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#808080;">&lt;</span><span style="color:#569CD6;">dependency</span><span style="color:#808080;">&gt;</span></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#808080;">&lt;</span><span style="color:#569CD6;">groupId</span><span style="color:#808080;">&gt;</span><span style="color:#D4D4D4;">com.alibaba.cloud</span><span style="color:#808080;">&lt;/</span><span style="color:#569CD6;">groupId</span><span style="color:#808080;">&gt;</span></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#808080;">&lt;</span><span style="color:#569CD6;">artifactId</span><span style="color:#808080;">&gt;</span><span style="color:#D4D4D4;">spring-cloud-starter-alibaba-nacos-config</span><span style="color:#808080;">&lt;/</span><span style="color:#569CD6;">artifactId</span><span style="color:#808080;">&gt;</span></span>
<span class="line"><span style="color:#808080;">&lt;/</span><span style="color:#569CD6;">dependency</span><span style="color:#808080;">&gt;</span></span>
<span class="line"><span style="color:#808080;">&lt;</span><span style="color:#569CD6;">dependency</span><span style="color:#808080;">&gt;</span></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#808080;">&lt;</span><span style="color:#569CD6;">groupId</span><span style="color:#808080;">&gt;</span><span style="color:#D4D4D4;">org.springframework.cloud</span><span style="color:#808080;">&lt;/</span><span style="color:#569CD6;">groupId</span><span style="color:#808080;">&gt;</span></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#808080;">&lt;</span><span style="color:#569CD6;">artifactId</span><span style="color:#808080;">&gt;</span><span style="color:#D4D4D4;">spring-cloud-starter-bootstrap</span><span style="color:#808080;">&lt;/</span><span style="color:#569CD6;">artifactId</span><span style="color:#808080;">&gt;</span></span>
<span class="line"><span style="color:#808080;">&lt;/</span><span style="color:#569CD6;">dependency</span><span style="color:#808080;">&gt;</span></span>
<span class="line"><span style="color:#808080;">&lt;/</span><span style="color:#569CD6;">dependencies</span><span style="color:#808080;">&gt;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>从 SpringCloud 2020 版本后不再默认加载 bootstrap 文件，如果需要加载 bootstrap 文件，则需要手动添加依赖。</p><h4 id="_5-2-2-nacos-配置中心配置" tabindex="-1"><a class="header-anchor" href="#_5-2-2-nacos-配置中心配置" aria-hidden="true">#</a> 5.2.2 Nacos 配置中心配置</h4><p>搭建 Nacos 配置中心时，需要将 Nacos 的配置中心信息放到 <code>bootstrap.yml</code> 文件中？</p><p>微服务要拉取 Nacos 中管理的配置，并且与本地的 <code>application.yml</code> 配置<strong>合并</strong>，才能完成项目启动，但本地尚未读取 <code>application.yml</code> 又如何获取 Nacos 配置中心地址呢？</p><p>除了 <code>application.yml</code> 配置文件外，SpringBoot 还提供了另一种配置文件 <code>bootstrap.yml</code> 文件，会在 <code>application.yml</code> 之前被读取，而且发生在拉取 Nacos 配置中心信息之前。</p><p>以 mall-user-server 服务为例，搭建 Nacos 的配置中心，可以在其 bootstrap.yml 中配置如下信息：</p><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="shiki dark-plus" style="background-color:#1E1E1E;" tabindex="0"><code><span class="line"><span style="color:#569CD6;">spring</span><span style="color:#D4D4D4;">:</span></span>
<span class="line"><span style="color:#D4D4D4;">  </span><span style="color:#569CD6;">cloud</span><span style="color:#D4D4D4;">:</span></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#569CD6;">nacos</span><span style="color:#D4D4D4;">:</span></span>
<span class="line"><span style="color:#D4D4D4;">      </span><span style="color:#569CD6;">server-addr</span><span style="color:#D4D4D4;">: </span><span style="color:#CE9178;">192.168.0.107:8848</span></span>
<span class="line"><span style="color:#D4D4D4;">      </span><span style="color:#569CD6;">discovery</span><span style="color:#D4D4D4;">:</span></span>
<span class="line"><span style="color:#D4D4D4;">        </span><span style="color:#569CD6;">service</span><span style="color:#D4D4D4;">: </span><span style="color:#CE9178;">\${spring.application.name}</span></span>
<span class="line"><span style="color:#D4D4D4;">        </span><span style="color:#569CD6;">server-addr</span><span style="color:#D4D4D4;">: </span><span style="color:#CE9178;">\${spring.cloud.nacos.server-addr}</span></span>
<span class="line"><span style="color:#D4D4D4;">      </span><span style="color:#569CD6;">config</span><span style="color:#D4D4D4;">:</span></span>
<span class="line"><span style="color:#D4D4D4;">        </span><span style="color:#569CD6;">server-addr</span><span style="color:#D4D4D4;">: </span><span style="color:#CE9178;">\${spring.cloud.nacos.server-addr}</span><span style="color:#D4D4D4;"> </span><span style="color:#6A9955;"># nacos 配置中心地址</span></span>
<span class="line"><span style="color:#D4D4D4;">        </span><span style="color:#569CD6;">file-extension</span><span style="color:#D4D4D4;">: </span><span style="color:#CE9178;">yml</span><span style="color:#D4D4D4;"> </span><span style="color:#6A9955;"># nacos 配置文件格式</span></span>
<span class="line"><span style="color:#D4D4D4;">        </span><span style="color:#569CD6;">prefix</span><span style="color:#D4D4D4;">: </span><span style="color:#CE9178;">\${spring.application.name}</span><span style="color:#D4D4D4;"> </span><span style="color:#6A9955;"># nacos 配置中心名字</span></span>
<span class="line"><span style="color:#D4D4D4;">        </span></span>
<span class="line"><span style="color:#D4D4D4;">  </span><span style="color:#569CD6;">profiles</span><span style="color:#D4D4D4;">:</span></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#569CD6;">active</span><span style="color:#D4D4D4;">: </span><span style="color:#CE9178;">dev</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">  </span><span style="color:#569CD6;">application</span><span style="color:#D4D4D4;">:</span></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#569CD6;">name</span><span style="color:#D4D4D4;">: </span><span style="color:#CE9178;">mall-user-server</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_5-2-3-在-nacos-中添加配置信息" tabindex="-1"><a class="header-anchor" href="#_5-2-3-在-nacos-中添加配置信息" aria-hidden="true">#</a> 5.2.3 在 Nacos 中添加配置信息</h4><p>点击 Nacos 控制台配置列表右上角的 “+” 号，即可进入新建配置页面，不同服务的配置是通过 <code>Data ID</code> 来区分的，其命名规则为：<code>\${prefix}-\${spring.profiles.active}.\${file-extension}</code></p><ul><li><p>prefix 默认为 <code>spring.application.name</code> 的值，也可以通过 <code>spring.cloud.nacos.config.prefix</code> 来指定；</p></li><li><p><code>spring.profiles.active</code> 即为当前环境对应的 profile，当 <code>spring.profiles.active</code> 为空时，对应的连接符 <code>-</code> 也将不存在，dataId 的拼接格式变成 <code>\${prefix}.\${file-extension}</code></p></li><li><p><code>file-exetension</code> 为配置内容的数据格式，可以通过配置项 <code>spring.cloud.nacos.config.file-extension</code> 来配置。目前只支持 properties 和 yaml 类型。</p></li></ul><p>如果我们要为 mall-user-server 添加配置信息，则其 Data ID 为：<code>mall-user-server-dev.yml</code>。</p><p>既然服务需要拉取 Nacos 配置中心管理的配置再与本地的 <code>application.yml</code> 中的配置进行合并，那么我们就可以只在本地保存 Nacos 拉取和注册需要的配置信息，将其它的配置信息都放到 Nacos，下面是 mall-user-server 的具体配置。</p><p><strong>bootstrap.yml</strong></p><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="shiki dark-plus" style="background-color:#1E1E1E;" tabindex="0"><code><span class="line"><span style="color:#569CD6;">server</span><span style="color:#D4D4D4;">:</span></span>
<span class="line"><span style="color:#D4D4D4;">  </span><span style="color:#569CD6;">port</span><span style="color:#D4D4D4;">: </span><span style="color:#B5CEA8;">7000</span></span>
<span class="line"></span>
<span class="line"><span style="color:#569CD6;">spring</span><span style="color:#D4D4D4;">:</span></span>
<span class="line"><span style="color:#D4D4D4;">  </span><span style="color:#569CD6;">application</span><span style="color:#D4D4D4;">:</span></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#569CD6;">name</span><span style="color:#D4D4D4;">: </span><span style="color:#CE9178;">mall-user-server</span></span>
<span class="line"><span style="color:#D4D4D4;">  </span><span style="color:#569CD6;">cloud</span><span style="color:#D4D4D4;">:</span></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#569CD6;">nacos</span><span style="color:#D4D4D4;">:</span></span>
<span class="line"><span style="color:#D4D4D4;">      </span><span style="color:#569CD6;">server-addr</span><span style="color:#D4D4D4;">: </span><span style="color:#CE9178;">192.168.0.107:8848</span></span>
<span class="line"><span style="color:#D4D4D4;">      </span><span style="color:#569CD6;">discovery</span><span style="color:#D4D4D4;">:</span></span>
<span class="line"><span style="color:#D4D4D4;">        </span><span style="color:#569CD6;">service</span><span style="color:#D4D4D4;">: </span><span style="color:#CE9178;">\${spring.application.name}</span></span>
<span class="line"><span style="color:#D4D4D4;">        </span><span style="color:#569CD6;">server-addr</span><span style="color:#D4D4D4;">: </span><span style="color:#CE9178;">\${spring.cloud.nacos.server-addr}</span></span>
<span class="line"><span style="color:#D4D4D4;">      </span><span style="color:#569CD6;">config</span><span style="color:#D4D4D4;">:</span></span>
<span class="line"><span style="color:#D4D4D4;">        </span><span style="color:#569CD6;">server-addr</span><span style="color:#D4D4D4;">: </span><span style="color:#CE9178;">\${spring.cloud.nacos.server-addr}</span></span>
<span class="line"><span style="color:#D4D4D4;">        </span><span style="color:#569CD6;">file-extension</span><span style="color:#D4D4D4;">: </span><span style="color:#CE9178;">yml</span></span>
<span class="line"><span style="color:#D4D4D4;">        </span><span style="color:#569CD6;">prefix</span><span style="color:#D4D4D4;">: </span><span style="color:#CE9178;">\${spring.application.name}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">  </span><span style="color:#569CD6;">profiles</span><span style="color:#D4D4D4;">:</span></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#569CD6;">active</span><span style="color:#D4D4D4;">: </span><span style="color:#CE9178;">dev</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>Nacos 配置中心配置</strong></p><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="shiki dark-plus" style="background-color:#1E1E1E;" tabindex="0"><code><span class="line"><span style="color:#569CD6;">spring</span><span style="color:#D4D4D4;">:</span></span>
<span class="line"><span style="color:#D4D4D4;">  </span><span style="color:#569CD6;">datasource</span><span style="color:#D4D4D4;">:</span></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#569CD6;">driver-class-name</span><span style="color:#D4D4D4;">: </span><span style="color:#CE9178;">com.mysql.cj.jdbc.Driver</span></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#569CD6;">url</span><span style="color:#D4D4D4;">: </span><span style="color:#CE9178;">jdbc://mysql:localhost:3306/mall_ums</span></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#569CD6;">username</span><span style="color:#D4D4D4;">: </span><span style="color:#CE9178;">root</span></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#569CD6;">password</span><span style="color:#D4D4D4;">: </span><span style="color:#CE9178;">root</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_5-2-4-配置热更新" tabindex="-1"><a class="header-anchor" href="#_5-2-4-配置热更新" aria-hidden="true">#</a> 5.2.4 配置热更新</h4><p>Nacos 也是支持配置的热更新的，下面以阿里云短信服务来介绍两种 Nacos 热更新的使用方式。</p><p>首先，在 mall-user-server 的 Nacos 配置中心上添加阿里云的短信服务配置：</p><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="shiki dark-plus" style="background-color:#1E1E1E;" tabindex="0"><code><span class="line"><span style="color:#569CD6;">sms</span><span style="color:#D4D4D4;">:</span></span>
<span class="line"><span style="color:#D4D4D4;">  </span><span style="color:#569CD6;">accessKey</span><span style="color:#D4D4D4;">: </span><span style="color:#CE9178;">LTAI5tMGtKPbL2bCp6zSU4Bz</span></span>
<span class="line"><span style="color:#D4D4D4;">  </span><span style="color:#569CD6;">accessKeySecret</span><span style="color:#D4D4D4;">: </span><span style="color:#CE9178;">baAdNzxAjnIMKU3wroxZLlpAACpy02</span></span>
<span class="line"><span style="color:#D4D4D4;">  </span><span style="color:#569CD6;">signName</span><span style="color:#D4D4D4;">: </span><span style="color:#CE9178;">gtzk</span></span>
<span class="line"><span style="color:#D4D4D4;">  </span><span style="color:#569CD6;">templateCode</span><span style="color:#D4D4D4;">: </span><span style="color:#CE9178;">SMS_183195440</span></span>
<span class="line"><span style="color:#D4D4D4;">  </span><span style="color:#569CD6;">doMain</span><span style="color:#D4D4D4;">: </span><span style="color:#CE9178;">dysmsapi.aliyuncs.com</span></span>
<span class="line"><span style="color:#D4D4D4;">  </span><span style="color:#569CD6;">regionId</span><span style="color:#D4D4D4;">: </span><span style="color:#CE9178;">cn-hangzhou</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>方式一：在 @Value 注入的变量所在类上添加注解 <strong>@RefreshScope</strong></p></blockquote><div class="language-java line-numbers-mode" data-ext="java"><pre class="shiki dark-plus" style="background-color:#1E1E1E;" tabindex="0"><code><span class="line"><span style="color:#D4D4D4;">@</span><span style="color:#4EC9B0;">RestController</span></span>
<span class="line"><span style="color:#D4D4D4;">@</span><span style="color:#4EC9B0;">RefreshScope</span></span>
<span class="line"><span style="color:#569CD6;">public</span><span style="color:#D4D4D4;"> </span><span style="color:#569CD6;">class</span><span style="color:#D4D4D4;"> </span><span style="color:#4EC9B0;">AliSmsController</span><span style="color:#D4D4D4;"> {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">    @</span><span style="color:#4EC9B0;">Value</span><span style="color:#D4D4D4;">(</span><span style="color:#CE9178;">&quot;\${sms.accessKey}&quot;</span><span style="color:#D4D4D4;">)</span></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#569CD6;">private</span><span style="color:#D4D4D4;"> </span><span style="color:#4EC9B0;">String</span><span style="color:#D4D4D4;"> </span><span style="color:#9CDCFE;">accessKey</span><span style="color:#D4D4D4;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">    @</span><span style="color:#4EC9B0;">Value</span><span style="color:#D4D4D4;">(</span><span style="color:#CE9178;">&quot;\${sms.accessKeySecret}&quot;</span><span style="color:#D4D4D4;">)</span></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#569CD6;">private</span><span style="color:#D4D4D4;"> </span><span style="color:#4EC9B0;">String</span><span style="color:#D4D4D4;"> </span><span style="color:#9CDCFE;">accessKeySecret</span><span style="color:#D4D4D4;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">    @</span><span style="color:#4EC9B0;">Value</span><span style="color:#D4D4D4;">(</span><span style="color:#CE9178;">&quot;\${sms.signName}&quot;</span><span style="color:#D4D4D4;">)</span></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#569CD6;">private</span><span style="color:#D4D4D4;"> </span><span style="color:#4EC9B0;">String</span><span style="color:#D4D4D4;"> </span><span style="color:#9CDCFE;">signName</span><span style="color:#D4D4D4;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">    @</span><span style="color:#4EC9B0;">Value</span><span style="color:#D4D4D4;">(</span><span style="color:#CE9178;">&quot;\${sms.templateCode}&quot;</span><span style="color:#D4D4D4;">)</span></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#569CD6;">private</span><span style="color:#D4D4D4;"> </span><span style="color:#4EC9B0;">String</span><span style="color:#D4D4D4;"> </span><span style="color:#9CDCFE;">templateCode</span><span style="color:#D4D4D4;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">    @</span><span style="color:#4EC9B0;">GetMapping</span><span style="color:#D4D4D4;">(</span><span style="color:#CE9178;">&quot;method1&quot;</span><span style="color:#D4D4D4;">)</span></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#569CD6;">public</span><span style="color:#D4D4D4;"> </span><span style="color:#4EC9B0;">Map</span><span style="color:#D4D4D4;">&lt;</span><span style="color:#4EC9B0;">String</span><span style="color:#D4D4D4;">,</span><span style="color:#4EC9B0;">String</span><span style="color:#D4D4D4;">&gt; </span><span style="color:#DCDCAA;">method1</span><span style="color:#D4D4D4;">() {</span></span>
<span class="line"><span style="color:#D4D4D4;">        </span><span style="color:#4EC9B0;">Map</span><span style="color:#D4D4D4;">&lt;</span><span style="color:#4EC9B0;">String</span><span style="color:#D4D4D4;">,</span><span style="color:#4EC9B0;">String</span><span style="color:#D4D4D4;">&gt; </span><span style="color:#9CDCFE;">result</span><span style="color:#D4D4D4;"> = </span><span style="color:#C586C0;">new</span><span style="color:#D4D4D4;"> </span><span style="color:#4EC9B0;">HashMap</span><span style="color:#D4D4D4;">&lt;&gt;();</span></span>
<span class="line"><span style="color:#D4D4D4;">        </span><span style="color:#9CDCFE;">result</span><span style="color:#D4D4D4;">.</span><span style="color:#DCDCAA;">put</span><span style="color:#D4D4D4;">(</span><span style="color:#CE9178;">&quot;accessKey&quot;</span><span style="color:#D4D4D4;">,accessKey);</span></span>
<span class="line"><span style="color:#D4D4D4;">        </span><span style="color:#9CDCFE;">result</span><span style="color:#D4D4D4;">.</span><span style="color:#DCDCAA;">put</span><span style="color:#D4D4D4;">(</span><span style="color:#CE9178;">&quot;accessKeySecret&quot;</span><span style="color:#D4D4D4;">,accessKeySecret);</span></span>
<span class="line"><span style="color:#D4D4D4;">        </span><span style="color:#9CDCFE;">result</span><span style="color:#D4D4D4;">.</span><span style="color:#DCDCAA;">put</span><span style="color:#D4D4D4;">(</span><span style="color:#CE9178;">&quot;signName&quot;</span><span style="color:#D4D4D4;">,signName);</span></span>
<span class="line"><span style="color:#D4D4D4;">        </span><span style="color:#9CDCFE;">result</span><span style="color:#D4D4D4;">.</span><span style="color:#DCDCAA;">put</span><span style="color:#D4D4D4;">(</span><span style="color:#CE9178;">&quot;templateCode&quot;</span><span style="color:#D4D4D4;">,templateCode);</span></span>
<span class="line"><span style="color:#D4D4D4;">        </span><span style="color:#C586C0;">return</span><span style="color:#D4D4D4;"> result;</span></span>
<span class="line"><span style="color:#D4D4D4;">    }</span></span>
<span class="line"><span style="color:#D4D4D4;">    </span></span>
<span class="line"><span style="color:#D4D4D4;">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>方式二：使用 @ConfigurationProperties 注解</p></blockquote><p>使用 <code>@ConfigurationProperties</code> 注解读取配置文件，不需要加 <code>@RefreshScope</code> 注解，就可以实现配置的热更新，一般也是使用这种方式。</p><p>首先，使用 <code>@ConfigurationProperties</code> 注解定义 sms 的配置：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="shiki dark-plus" style="background-color:#1E1E1E;" tabindex="0"><code><span class="line"><span style="color:#D4D4D4;">@</span><span style="color:#4EC9B0;">ConfigurationProperties</span><span style="color:#D4D4D4;">(prefix = </span><span style="color:#CE9178;">&quot;sms&quot;</span><span style="color:#D4D4D4;">)</span></span>
<span class="line"><span style="color:#D4D4D4;">@</span><span style="color:#4EC9B0;">Component</span></span>
<span class="line"><span style="color:#D4D4D4;">@</span><span style="color:#4EC9B0;">Data</span></span>
<span class="line"><span style="color:#569CD6;">public</span><span style="color:#D4D4D4;"> </span><span style="color:#569CD6;">class</span><span style="color:#D4D4D4;"> </span><span style="color:#4EC9B0;">AliSmsProperties</span><span style="color:#D4D4D4;"> {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#569CD6;">private</span><span style="color:#D4D4D4;"> </span><span style="color:#4EC9B0;">String</span><span style="color:#D4D4D4;"> </span><span style="color:#9CDCFE;">accessKey</span><span style="color:#D4D4D4;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#569CD6;">private</span><span style="color:#D4D4D4;"> </span><span style="color:#4EC9B0;">String</span><span style="color:#D4D4D4;"> </span><span style="color:#9CDCFE;">accessKeySecret</span><span style="color:#D4D4D4;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#569CD6;">private</span><span style="color:#D4D4D4;"> </span><span style="color:#4EC9B0;">String</span><span style="color:#D4D4D4;"> </span><span style="color:#9CDCFE;">signName</span><span style="color:#D4D4D4;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#569CD6;">private</span><span style="color:#D4D4D4;"> </span><span style="color:#4EC9B0;">String</span><span style="color:#D4D4D4;"> </span><span style="color:#9CDCFE;">templateCode</span><span style="color:#D4D4D4;">;</span></span>
<span class="line"><span style="color:#D4D4D4;">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>接着使用 @Autowired 注解在使用处注入即可：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="shiki dark-plus" style="background-color:#1E1E1E;" tabindex="0"><code><span class="line"><span style="color:#D4D4D4;">@</span><span style="color:#4EC9B0;">RestController</span></span>
<span class="line"><span style="color:#569CD6;">public</span><span style="color:#D4D4D4;"> </span><span style="color:#569CD6;">class</span><span style="color:#D4D4D4;"> </span><span style="color:#4EC9B0;">UserController</span><span style="color:#D4D4D4;"> {</span></span>
<span class="line"><span style="color:#D4D4D4;">    </span></span>
<span class="line"><span style="color:#D4D4D4;">    @</span><span style="color:#4EC9B0;">Autowired</span></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#569CD6;">private</span><span style="color:#D4D4D4;"> </span><span style="color:#4EC9B0;">AliSmsProperties</span><span style="color:#D4D4D4;"> </span><span style="color:#9CDCFE;">aliSmsProperties</span><span style="color:#D4D4D4;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">    @</span><span style="color:#4EC9B0;">GetMapping</span><span style="color:#D4D4D4;">(</span><span style="color:#CE9178;">&quot;method2&quot;</span><span style="color:#D4D4D4;">)</span></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#569CD6;">public</span><span style="color:#D4D4D4;"> </span><span style="color:#4EC9B0;">Map</span><span style="color:#D4D4D4;">&lt;</span><span style="color:#4EC9B0;">String</span><span style="color:#D4D4D4;">,</span><span style="color:#4EC9B0;">String</span><span style="color:#D4D4D4;">&gt; </span><span style="color:#DCDCAA;">method2</span><span style="color:#D4D4D4;">() {</span></span>
<span class="line"><span style="color:#D4D4D4;">        </span><span style="color:#4EC9B0;">Map</span><span style="color:#D4D4D4;">&lt;</span><span style="color:#4EC9B0;">String</span><span style="color:#D4D4D4;">,</span><span style="color:#4EC9B0;">String</span><span style="color:#D4D4D4;">&gt; </span><span style="color:#9CDCFE;">result</span><span style="color:#D4D4D4;"> = </span><span style="color:#C586C0;">new</span><span style="color:#D4D4D4;"> </span><span style="color:#4EC9B0;">HashMap</span><span style="color:#D4D4D4;">&lt;&gt;();</span></span>
<span class="line"><span style="color:#D4D4D4;">        </span><span style="color:#9CDCFE;">result</span><span style="color:#D4D4D4;">.</span><span style="color:#DCDCAA;">put</span><span style="color:#D4D4D4;">(</span><span style="color:#CE9178;">&quot;accessKey&quot;</span><span style="color:#D4D4D4;">,</span><span style="color:#9CDCFE;">aliSmsProperties</span><span style="color:#D4D4D4;">.</span><span style="color:#DCDCAA;">getAccessKey</span><span style="color:#D4D4D4;">());</span></span>
<span class="line"><span style="color:#D4D4D4;">        </span><span style="color:#9CDCFE;">result</span><span style="color:#D4D4D4;">.</span><span style="color:#DCDCAA;">put</span><span style="color:#D4D4D4;">(</span><span style="color:#CE9178;">&quot;accessKeySecret&quot;</span><span style="color:#D4D4D4;">,</span><span style="color:#9CDCFE;">aliSmsProperties</span><span style="color:#D4D4D4;">.</span><span style="color:#DCDCAA;">getAccessKeySecret</span><span style="color:#D4D4D4;">());</span></span>
<span class="line"><span style="color:#D4D4D4;">        </span><span style="color:#9CDCFE;">result</span><span style="color:#D4D4D4;">.</span><span style="color:#DCDCAA;">put</span><span style="color:#D4D4D4;">(</span><span style="color:#CE9178;">&quot;signName&quot;</span><span style="color:#D4D4D4;">,</span><span style="color:#9CDCFE;">aliSmsProperties</span><span style="color:#D4D4D4;">.</span><span style="color:#DCDCAA;">getSignName</span><span style="color:#D4D4D4;">());</span></span>
<span class="line"><span style="color:#D4D4D4;">        </span><span style="color:#9CDCFE;">result</span><span style="color:#D4D4D4;">.</span><span style="color:#DCDCAA;">put</span><span style="color:#D4D4D4;">(</span><span style="color:#CE9178;">&quot;templateCode&quot;</span><span style="color:#D4D4D4;">,</span><span style="color:#9CDCFE;">aliSmsProperties</span><span style="color:#D4D4D4;">.</span><span style="color:#DCDCAA;">getTemplateCode</span><span style="color:#D4D4D4;">());</span></span>
<span class="line"><span style="color:#D4D4D4;">        </span><span style="color:#C586C0;">return</span><span style="color:#D4D4D4;"> result;</span></span>
<span class="line"><span style="color:#D4D4D4;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_5-2-5-多个服务共享配置" tabindex="-1"><a class="header-anchor" href="#_5-2-5-多个服务共享配置" aria-hidden="true">#</a> 5.2.5 多个服务共享配置</h4><p>在实际开发过程中，如果遇到多个服务用到相同的配置，可以将重复的配置抽取出来，然后在每个服务中引用即可。例如，我们在 Nacos 配置中心新建了一个 common.yml 的配置文件，则可以使用如下方式在每个服务中引用：</p><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="shiki dark-plus" style="background-color:#1E1E1E;" tabindex="0"><code><span class="line"><span style="color:#569CD6;">server</span><span style="color:#D4D4D4;">:</span></span>
<span class="line"><span style="color:#D4D4D4;">  </span><span style="color:#569CD6;">port</span><span style="color:#D4D4D4;">: </span><span style="color:#B5CEA8;">7000</span></span>
<span class="line"></span>
<span class="line"><span style="color:#569CD6;">spring</span><span style="color:#D4D4D4;">:</span></span>
<span class="line"><span style="color:#D4D4D4;">  </span><span style="color:#569CD6;">application</span><span style="color:#D4D4D4;">:</span></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#569CD6;">name</span><span style="color:#D4D4D4;">: </span><span style="color:#CE9178;">mall-user-server</span></span>
<span class="line"><span style="color:#D4D4D4;">  </span><span style="color:#569CD6;">cloud</span><span style="color:#D4D4D4;">:</span></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#569CD6;">nacos</span><span style="color:#D4D4D4;">:</span></span>
<span class="line"><span style="color:#D4D4D4;">      </span><span style="color:#569CD6;">server-addr</span><span style="color:#D4D4D4;">: </span><span style="color:#CE9178;">192.168.0.110:8848</span></span>
<span class="line"><span style="color:#D4D4D4;">      </span><span style="color:#569CD6;">discovery</span><span style="color:#D4D4D4;">:</span></span>
<span class="line"><span style="color:#D4D4D4;">        </span><span style="color:#569CD6;">service</span><span style="color:#D4D4D4;">: </span><span style="color:#CE9178;">\${spring.application.name}</span></span>
<span class="line"><span style="color:#D4D4D4;">        </span><span style="color:#569CD6;">server-addr</span><span style="color:#D4D4D4;">: </span><span style="color:#CE9178;">\${spring.cloud.nacos.server-addr}</span></span>
<span class="line"><span style="color:#D4D4D4;">      </span><span style="color:#569CD6;">config</span><span style="color:#D4D4D4;">:</span></span>
<span class="line"><span style="color:#D4D4D4;">        </span><span style="color:#569CD6;">server-addr</span><span style="color:#D4D4D4;">: </span><span style="color:#CE9178;">\${spring.cloud.nacos.server-addr}</span></span>
<span class="line"><span style="color:#D4D4D4;">        </span><span style="color:#569CD6;">file-extension</span><span style="color:#D4D4D4;">: </span><span style="color:#CE9178;">yml</span></span>
<span class="line"><span style="color:#D4D4D4;">        </span><span style="color:#569CD6;">prefix</span><span style="color:#D4D4D4;">: </span><span style="color:#CE9178;">\${spring.application.name}</span></span>
<span class="line"><span style="color:#D4D4D4;">        </span><span style="color:#569CD6;">shared-configs</span><span style="color:#D4D4D4;">: </span><span style="color:#6A9955;"># 共享配置列表</span></span>
<span class="line"><span style="color:#D4D4D4;">          - </span><span style="color:#569CD6;">data-id</span><span style="color:#D4D4D4;">: </span><span style="color:#CE9178;">common.yml</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">  </span><span style="color:#569CD6;">profiles</span><span style="color:#D4D4D4;">:</span></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#569CD6;">active</span><span style="color:#D4D4D4;">: </span><span style="color:#CE9178;">dev</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,67);function k(A,B){const a=o("ExternalLinkIcon");return c(),r("div",null,[D,t,s("p",null,[n("官网地址："),s("a",d,[n("https://nacos.io"),l(a)])]),s("p",null,[n("GitHub地址："),s("a",y,[n("https://github.com/alibaba/nacos"),l(a)])]),v,u,m,b,C,s("p",null,[n("SpringCloud Alibaba 对应的 Nacos 版本可以在 SpringCloud Aibaba 的 "),s("a",g,[n("Github 地址"),l(a)]),n(" 查看，我这里下载的是 1.4.2 版本的 Nacos，下载地址为："),s("a",h,[n("https://github.com/alibaba/nacos/releases。"),l(a)])]),E,s("p",null,[n("启动后，在浏览器访问 "),s("a",f,[n("http://localhost:8848/nacos"),l(a)]),n(" 即可进入 Nacos 的控制台的登陆界面，默认的用户名和密码都是 nacos。")]),N,s("p",null,[n("启动 Nginx 后，即可访问 "),s("a",_,[n("http://localhost:80/nacos"),l(a)]),n(" 来检查是否代理成功：")]),x])}const I=p(i,[["render",k],["__file","003-Nacos服务注册与配置中心.html.vue"]]);export{I as default};
